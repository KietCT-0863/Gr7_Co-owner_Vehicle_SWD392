@page
@model Co_owner_Vehicle.Pages.Expenses.IndexModel
@{
    ViewData["Title"] = "Qu·∫£n l√Ω chi ph√≠";
}

<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold mb-1">
            <i class="bi bi-receipt text-primary me-2"></i>Qu·∫£n l√Ω chi ph√≠
        </h2>
        <p class="text-muted mb-0">Theo d√µi v√† chia s·∫ª chi ph√≠ v·∫≠n h√†nh xe</p>
    </div>
    <a asp-page="/Expenses/Create" class="btn btn-primary">
        <i class="bi bi-plus-lg me-2"></i>Th√™m chi ph√≠
    </a>
</div>

<!-- Summary Cards -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-card-icon warning">
                <i class="bi bi-receipt"></i>
            </div>
            <div class="stat-card-value">@((Model.Stats.TotalThisMonth / 1000000).ToString("F1"))M</div>
            <div class="stat-card-label">T·ªïng chi ph√≠ th√°ng n√†y</div>
            <div class="stat-card-change @(Model.Stats.PercentageChange < 0 ? "negative" : "positive")">
                <i class="bi bi-arrow-@(Model.Stats.PercentageChange < 0 ? "down" : "up")"></i> 
                @(Model.Stats.PercentageChange.ToString("F0"))% so th√°ng tr∆∞·ªõc
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-card-icon success">
                <i class="bi bi-check-circle"></i>
            </div>
            <div class="stat-card-value">@Model.Stats.ApprovedThisMonth</div>
            <div class="stat-card-label">ƒê√£ duy·ªát</div>
            <div class="stat-card-change positive">
                <i class="bi bi-arrow-up"></i> Th√°ng n√†y
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-card-icon warning">
                <i class="bi bi-clock-history"></i>
            </div>
            <div class="stat-card-value">@Model.Stats.PendingThisMonth</div>
            <div class="stat-card-label">Ch·ªù duy·ªát</div>
            <div class="stat-card-change">
                C·∫ßn xem x√©t
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-card-icon danger">
                <i class="bi bi-credit-card"></i>
            </div>
            <div class="stat-card-value">@((Model.Stats.UserShareThisMonth / 1000000).ToString("F1"))M</div>
            <div class="stat-card-label">Ph·∫ßn c·ªßa b·∫°n</div>
            <div class="stat-card-change">
                Th√°ng n√†y
            </div>
        </div>
    </div>
</div>

<!-- Filter & Search -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small">T√¨m ki·∫øm</label>
                    <input type="text" class="form-control" name="searchTerm" asp-for="SearchTerm" placeholder="üîç T√¨m theo t√™n, m√¥ t·∫£...">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Xe</label>
                    <select class="form-select" name="vehicleIdFilter" asp-for="VehicleIdFilter">
                        <option value="">T·∫•t c·∫£</option>
                        @foreach (var vehicle in Model.Vehicles)
                        {
                            <option value="@vehicle.VehicleId">@vehicle.Brand @vehicle.Model</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Danh m·ª•c</label>
                    <select class="form-select" name="categoryIdFilter" asp-for="CategoryIdFilter">
                        <option value="">T·∫•t c·∫£</option>
                        @foreach (var category in Model.Categories)
                        {
                            <option value="@category.ExpenseCategoryId">@category.CategoryName</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Tr·∫°ng th√°i</label>
                    <select class="form-select" name="statusFilter" asp-for="StatusFilter">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="@ExpenseStatus.Pending">Ch·ªù duy·ªát</option>
                        <option value="@ExpenseStatus.Approved">ƒê√£ duy·ªát</option>
                        <option value="@ExpenseStatus.Rejected">T·ª´ ch·ªëi</option>
                        <option value="@ExpenseStatus.Paid">ƒê√£ thanh to√°n</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Th·ªùi gian</label>
                    <select class="form-select" name="timeFilter" asp-for="TimeFilter">
                        <option value="Th√°ng n√†y">Th√°ng n√†y</option>
                        <option value="Th√°ng tr∆∞·ªõc">Th√°ng tr∆∞·ªõc</option>
                        <option value="3 th√°ng">3 th√°ng</option>
                        <option value="T·∫•t c·∫£">T·∫•t c·∫£</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Expenses Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>Danh s√°ch chi ph√≠</span>
        <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary active">
                <i class="bi bi-table me-1"></i>B·∫£ng
            </button>
            <button class="btn btn-outline-secondary">
                <i class="bi bi-grid-3x3 me-1"></i>Th·∫ª
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Chi ph√≠</th>
                        <th>Xe</th>
                        <th>Ng√†y</th>
                        <th>T·ªïng ti·ªÅn</th>
                        <th>Ph·∫ßn c·ªßa b·∫°n</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Ng∆∞·ªùi duy·ªát</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Expenses.Any())
                    {
                        @foreach (var expense in Model.Expenses)
                        {
                            var statusBadge = expense.Status switch
                            {
                                ExpenseStatus.Pending => ("bg-warning", "Ch·ªù duy·ªát"),
                                ExpenseStatus.Approved => ("bg-success", "ƒê√£ duy·ªát"),
                                ExpenseStatus.Rejected => ("bg-danger", "T·ª´ ch·ªëi"),
                                ExpenseStatus.Paid => ("bg-primary", "ƒê√£ thanh to√°n"),
                                _ => ("bg-secondary", expense.Status.ToString())
                            };

                            var categoryIcon = expense.ExpenseCategory.CategoryName switch
                            {
                                "Ph√≠ s·∫°c ƒëi·ªán" => "bi-lightning-charge",
                                "B·∫£o d∆∞·ª°ng" => "bi-tools",
                                "B·∫£o hi·ªÉm" => "bi-shield-check",
                                "V·ªá sinh" => "bi-droplet",
                                "S·ª≠a ch·ªØa" => "bi-wrench",
                                _ => "bi-receipt"
                            };

                            var categoryColor = expense.ExpenseCategory.CategoryName switch
                            {
                                "Ph√≠ s·∫°c ƒëi·ªán" => "warning",
                                "B·∫£o d∆∞·ª°ng" => "primary",
                                "B·∫£o hi·ªÉm" => "danger",
                                "V·ªá sinh" => "success",
                                "S·ª≠a ch·ªØa" => "info",
                                _ => "secondary"
                            };

                            var timeAgo = DateTime.UtcNow - expense.ExpenseDate;
                            var timeAgoText = timeAgo.Days switch
                            {
                                0 => "H√¥m nay",
                                1 => "H√¥m qua",
                                < 7 => $"{timeAgo.Days} ng√†y tr∆∞·ªõc",
                                < 30 => $"{timeAgo.Days / 7} tu·∫ßn tr∆∞·ªõc",
                                _ => $"{timeAgo.Days / 30} th√°ng tr∆∞·ªõc"
                            };

                            var userSharePercentage = expense.Amount > 0 ? (expense.UserShare / expense.Amount) * 100 : 0;

                            <tr class="@(expense.Status == ExpenseStatus.Pending ? "table-warning" : "")">
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="stat-card-icon @categoryColor" style="width: 40px; height: 40px;">
                                            <i class="bi @categoryIcon fs-6"></i>
                                        </div>
                                        <div>
                                            <strong>@expense.ExpenseTitle</strong><br>
                                            <small class="text-muted">@(expense.VendorName ?? expense.ExpenseCategory.CategoryName)</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <strong>@expense.Vehicle.Brand @expense.Vehicle.Model</strong><br>
                                    <small class="text-muted">@expense.Vehicle.LicensePlate</small>
                                </td>
                                <td>
                                    @expense.ExpenseDate.ToString("dd/MM/yyyy")<br>
                                    <small class="text-muted">@timeAgoText</small>
                                </td>
                                <td><strong class="text-primary">@expense.Amount.ToString("N0")‚Ç´</strong></td>
                                <td>
                                    <strong>@expense.UserShare.ToString("N0")‚Ç´</strong><br>
                                    <small class="text-muted">(@userSharePercentage.ToString("F0")%)</small>
                                </td>
                                <td><span class="badge @statusBadge.Item1">@statusBadge.Item2</span></td>
                                <td>
                                    @if (expense.ApprovedByUser != null)
                                    {
                                        var initials = expense.ApprovedByUser.FullName?.Split(' ').Select(n => n[0]).Take(2).Aggregate("", (a, b) => a + b).ToUpper() ?? "U";
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-xs bg-primary text-white me-1">@initials</div>
                                            <small>@expense.ApprovedByUser.FullName</small>
                                        </div>
                                    }
                                    else
                                    {
                                        <small class="text-muted">Ch∆∞a duy·ªát</small>
                                    }
                                </td>
                                <td>
                                    @if (expense.Status == ExpenseStatus.Pending && (Model.IsAdmin() || Model.IsStaff()))
                                    {
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-success" title="Duy·ªát">
                                                <i class="bi bi-check-lg"></i>
                                            </button>
                                            <button class="btn btn-danger" title="T·ª´ ch·ªëi">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-link text-muted" data-bs-toggle="dropdown">
                                                <i class="bi bi-three-dots-vertical"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end">
                                                <li><a class="dropdown-item" asp-page="/Expenses/Details" asp-route-id="@expense.ExpenseId"><i class="bi bi-eye me-2"></i>Chi ti·∫øt</a></li>
                                                @if (!string.IsNullOrEmpty(expense.ReceiptPath))
                                                {
                                                    <li><a class="dropdown-item" href="@expense.ReceiptPath" target="_blank"><i class="bi bi-file-earmark me-2"></i>Xem h√≥a ƒë∆°n</a></li>
                                                }
                                            </ul>
                                        </div>
                                    }
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                    Kh√¥ng c√≥ chi ph√≠ n√†o
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
    @if (Model.Expenses.Count >= 50)
    {
        <div class="card-footer bg-transparent">
            <div class="alert alert-info mb-0">
                <i class="bi bi-info-circle me-1"></i>
                Hi·ªÉn th·ªã 50 b·∫£n ghi g·∫ßn nh·∫•t. S·ª≠ d·ª•ng b·ªô l·ªçc ƒë·ªÉ t√¨m ki·∫øm c·ª• th·ªÉ h∆°n.
            </div>
        </div>
    }
</div>

<!-- Add Expense Modal -->
<div class="modal fade" id="addExpenseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle text-primary me-2"></i>Th√™m chi ph√≠ m·ªõi
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Ch·ªçn xe <span class="text-danger">*</span></label>
                            <select class="form-select" required>
                                <option value="">-- Ch·ªçn xe --</option>
                                <option>Tesla Model 3 - 30A-12345</option>
                                <option>Toyota Prius - 30B-67890</option>
                                <option>Honda Civic - 30C-11111</option>
                                <option>VinFast VF8 - 30D-22222</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Danh m·ª•c chi ph√≠ <span class="text-danger">*</span></label>
                            <select class="form-select" required>
                                <option value="">-- Ch·ªçn danh m·ª•c --</option>
                                <option>Ph√≠ s·∫°c ƒëi·ªán</option>
                                <option>B·∫£o d∆∞·ª°ng ƒë·ªãnh k·ª≥</option>
                                <option>B·∫£o hi·ªÉm xe</option>
                                <option>ƒêƒÉng ki·ªÉm</option>
                                <option>V·ªá sinh xe</option>
                                <option>S·ª≠a ch·ªØa</option>
                                <option>Nhi√™n li·ªáu</option>
                                <option>Kh√°c</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Ti√™u ƒë·ªÅ chi ph√≠ <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" placeholder="VD: Ph√≠ s·∫°c ƒëi·ªán th√°ng 10" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">S·ªë ti·ªÅn <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" placeholder="500000" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Ng√†y chi <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Nh√† cung c·∫•p</label>
                            <input type="text" class="form-control" placeholder="T√™n nh√† cung c·∫•p">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Ph∆∞∆°ng th·ª©c chia</label>
                            <select class="form-select">
                                <option>Theo t·ª∑ l·ªá s·ªü h·ªØu</option>
                                <option>Theo m·ª©c ƒë·ªô s·ª≠ d·ª•ng</option>
                                <option>Chia ƒë·ªÅu</option>
                                <option>T√πy ch·ªânh</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">H√≥a ƒë∆°n / Bi√™n lai</label>
                            <input type="file" class="form-control" accept="image/*,.pdf">
                            <small class="text-muted">H·ªó tr·ª£: JPG, PNG, PDF (Max 5MB)</small>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Ghi ch√∫</label>
                            <textarea class="form-control" rows="3" placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ chi ph√≠..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary">
                    <i class="bi bi-check-lg me-2"></i>Th√™m chi ph√≠
                </button>
            </div>
        </div>
    </div>
</div>

