@page
@model Co_owner_Vehicle.Pages.Bookings.DetailsModel
@{
    ViewData["Title"] = "Chi tiết đặt lịch";
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (Model.Booking == null)
{
    <div class="alert alert-danger">
        Không tìm thấy lịch đặt này
    </div>
}
else
{
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-2">
                <li class="breadcrumb-item"><a asp-page="/Bookings/Calendar">Đặt lịch</a></li>
                <li class="breadcrumb-item active">Chi tiết</li>
            </ol>
        </nav>
        <h2 class="fw-bold mb-1">
            <i class="bi bi-calendar-check text-primary me-2"></i>Chi tiết đặt lịch
        </h2>
        <p class="text-muted mb-0">Thông tin chi tiết và quản lý đặt lịch sử dụng xe</p>
    </div>
    <div class="btn-group">
        <button class="btn btn-outline-primary">
            <i class="bi bi-pencil me-2"></i>Chỉnh sửa
        </button>
        <button class="btn btn-outline-danger">
            <i class="bi bi-x-circle me-2"></i>Hủy đặt lịch
        </button>
        <button class="btn btn-primary">
            <i class="bi bi-printer me-2"></i>In
        </button>
    </div>
</div>

<!-- Booking Header Card -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-4">
            <div class="col-md-8">
                <div class="d-flex align-items-start gap-3 mb-3">
                    <div class="bg-primary bg-opacity-10 p-3 rounded">
                        <i class="bi bi-calendar-event fs-1 text-primary"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h4 class="fw-bold mb-2">Đặt lịch sử dụng xe</h4>
                        <div class="d-flex gap-2 flex-wrap mb-2">
                            @{
                                var statusBadgeClass = Model.Booking.Status switch
                                {
                                    BookingStatus.Confirmed => "success",
                                    BookingStatus.Pending => "warning",
                                    BookingStatus.Cancelled => "danger",
                                    BookingStatus.Completed => "info",
                                    _ => "secondary"
                                };
                                var priorityBadgeClass = Model.Booking.Priority switch
                                {
                                    PriorityLevel.High => "danger",
                                    PriorityLevel.Normal => "primary",
                                    PriorityLevel.Low => "secondary",
                                    _ => "primary"
                                };
                            }
                            <span class="badge bg-@statusBadgeClass fs-6">@Model.Booking.Status switch
                            {
                                BookingStatus.Confirmed => "Đã xác nhận",
                                BookingStatus.Pending => "Chờ duyệt",
                                BookingStatus.Cancelled => "Đã hủy",
                                BookingStatus.Completed => "Hoàn thành",
                                _ => Model.Booking.Status.ToString()
                            }</span>
                            @if (Model.Booking.Priority == PriorityLevel.High)
                            {
                                <span class="badge bg-@priorityBadgeClass">Ưu tiên cao</span>
                            }
                        </div>
                        @if (!string.IsNullOrEmpty(Model.Booking.Purpose))
                        {
                            <p class="text-muted mb-0">@Model.Booking.Purpose</p>
                        }
                    </div>
                </div>

                <div class="row g-3 mt-3">
                    <div class="col-md-6">
                        <label class="form-label small text-muted">Xe</label>
                        <p class="mb-0">
                            <i class="bi bi-car-front me-1"></i>@Model.Booking.Vehicle?.Brand @Model.Booking.Vehicle?.Model - @Model.Booking.Vehicle?.LicensePlate
                        </p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small text-muted">Người đặt</label>
                        <div class="d-flex align-items-center">
                            @{
                                var userInitials = string.Join("", (Model.Booking.User?.FullName ?? "").Split(' ').Select(n => n.Length > 0 ? n[0].ToString() : "").Take(2));
                            }
                            <div class="avatar-xs bg-primary text-white me-2">@userInitials</div>
                            <span>@Model.Booking.User?.FullName</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small text-muted">Thời gian bắt đầu</label>
                        <p class="mb-0">
                            <i class="bi bi-calendar3 me-1"></i>@Model.Booking.StartTime.ToString("dd/MM/yyyy HH:mm")
                        </p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small text-muted">Thời gian kết thúc</label>
                        <p class="mb-0">
                            <i class="bi bi-calendar3 me-1"></i>@Model.Booking.EndTime.ToString("dd/MM/yyyy HH:mm")
                        </p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small text-muted">Thời lượng</label>
                        <p class="mb-0"><strong>@Math.Round((Model.Booking.EndTime - Model.Booking.StartTime).TotalHours, 1) giờ</strong></p>
                    </div>
                    @if (Model.Booking.ConfirmedByUser != null)
                    {
                        <div class="col-md-6">
                            <label class="form-label small text-muted">Người duyệt</label>
                            <div class="d-flex align-items-center">
                                @{
                                    var confirmedByInitials = string.Join("", (Model.Booking.ConfirmedByUser.FullName ?? "").Split(' ').Select(n => n.Length > 0 ? n[0].ToString() : "").Take(2));
                                }
                                <div class="avatar-xs bg-success text-white me-2">@confirmedByInitials</div>
                                <span>@Model.Booking.ConfirmedByUser.FullName</span>
                            </div>
                        </div>
                    }
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="mb-3">Trạng thái</h6>
                        <div class="mb-3 pb-3 border-bottom">
                            <span class="badge bg-@statusBadgeClass fs-6">@Model.Booking.Status switch
                            {
                                BookingStatus.Confirmed => "Đã xác nhận",
                                BookingStatus.Pending => "Chờ duyệt",
                                BookingStatus.Cancelled => "Đã hủy",
                                BookingStatus.Completed => "Hoàn thành",
                                _ => Model.Booking.Status.ToString()
                            }</span>
                            @if (Model.Booking.ConfirmedByUser != null && Model.Booking.ConfirmedAt.HasValue)
                            {
                                <p class="text-muted small mb-0 mt-2">Duyệt bởi: @Model.Booking.ConfirmedByUser.FullName</p>
                                <p class="text-muted small mb-0">Ngày: @Model.Booking.ConfirmedAt.Value.ToString("dd/MM/yyyy HH:mm")</p>
                            }
                        </div>
                        <div class="mb-3 pb-3 border-bottom">
                            <small class="text-muted">Check-in</small>
                            <p class="mb-0">
                                @{
                                    var hasCheckIn = Model.CheckInOutRecords.Any(r => r.Type == CheckInOutType.CheckIn && r.BookingScheduleId == Model.Booking.BookingScheduleId);
                                }
                                <span class="badge bg-@(hasCheckIn ? "success" : "secondary")">@(hasCheckIn ? "Đã check-in" : "Chưa check-in")</span>
                            </p>
                        </div>
                        <div>
                            <small class="text-muted">Check-out</small>
                            <p class="mb-0">
                                @{
                                    var hasCheckOut = Model.CheckInOutRecords.Any(r => r.Type == CheckInOutType.CheckOut && r.BookingScheduleId == Model.Booking.BookingScheduleId);
                                }
                                <span class="badge bg-@(hasCheckOut ? "success" : "secondary")">@(hasCheckOut ? "Đã check-out" : "Chưa check-out")</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Left Column -->
    <div class="col-lg-8">
        <!-- Check-in/Check-out Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-box-arrow-in-right me-2"></i>Check-in / Check-out
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="p-3 bg-light rounded mb-3">
                            <h6 class="mb-3">Check-in</h6>
                            <div class="mb-3">
                                <label class="form-label small">Số km khi nhận xe</label>
                                <input type="number" class="form-control" placeholder="15000">
                            </div>
                            <div class="mb-3">
                                <label class="form-label small">Trạng thái xe</label>
                                <select class="form-select">
                                    <option>Tốt</option>
                                    <option>Bình thường</option>
                                    <option>Có vấn đề nhỏ</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small">Ghi chú</label>
                                <textarea class="form-control" rows="2" placeholder="Ghi chú khi nhận xe..."></textarea>
                            </div>
                            <button class="btn btn-success w-100">
                                <i class="bi bi-check-circle me-2"></i>Check-in ngay
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="p-3 bg-light rounded mb-3">
                            <h6 class="mb-3">Check-out</h6>
                            <div class="mb-3">
                                <label class="form-label small">Số km khi trả xe</label>
                                <input type="number" class="form-control" placeholder="15080">
                            </div>
                            <div class="mb-3">
                                <label class="form-label small">Tổng số km đã đi</label>
                                <input type="number" class="form-control" placeholder="80" disabled>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small">Trạng thái xe khi trả</label>
                                <select class="form-select">
                                    <option>Tốt</option>
                                    <option>Bình thường</option>
                                    <option>Có vấn đề nhỏ</option>
                                    <option>Có hư hỏng</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small">Ghi chú</label>
                                <textarea class="form-control" rows="2" placeholder="Ghi chú khi trả xe..."></textarea>
                            </div>
                            <button class="btn btn-primary w-100" disabled>
                                <i class="bi bi-box-arrow-left me-2"></i>Check-out
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Usage History -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-clock-history me-2"></i>Lịch sử sử dụng
                </h6>
            </div>
            <div class="card-body">
                <div class="timeline">
                    @if (Model.Booking.CreatedAt != null)
                    {
                        <div class="timeline-item">
                            <div class="timeline-marker bg-info"></div>
                            <div class="timeline-content">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">Đặt lịch được tạo</h6>
                                        <p class="text-muted mb-1 small">Bởi: @Model.Booking.User?.FullName</p>
                                        <small class="text-muted">@Model.Booking.CreatedAt.ToString("dd/MM/yyyy HH:mm")</small>
                                    </div>
                                    <span class="badge bg-info">Mới tạo</span>
                                </div>
                            </div>
                        </div>
                    }
                    @if (Model.Booking.ConfirmedAt != null)
                    {
                        <div class="timeline-item">
                            <div class="timeline-marker bg-success"></div>
                            <div class="timeline-content">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">Đặt lịch được duyệt</h6>
                                        <p class="text-muted mb-1 small">Bởi: @Model.Booking.ConfirmedByUser?.FullName</p>
                                        <small class="text-muted">@Model.Booking.ConfirmedAt.Value.ToString("dd/MM/yyyy HH:mm")</small>
                                    </div>
                                    <span class="badge bg-success">Đã duyệt</span>
                                </div>
                            </div>
                        </div>
                    }
                    @if (Model.Booking.CancelledAt != null)
                    {
                        <div class="timeline-item">
                            <div class="timeline-marker bg-danger"></div>
                            <div class="timeline-content">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">Đặt lịch đã bị hủy</h6>
                                        <p class="text-muted mb-1 small">@Model.Booking.CancellationReason</p>
                                        <small class="text-muted">@Model.Booking.CancelledAt.Value.ToString("dd/MM/yyyy HH:mm")</small>
                                    </div>
                                    <span class="badge bg-danger">Đã hủy</span>
                                </div>
                            </div>
                        </div>
                    }
                    @if (Model.Booking.CompletedAt != null)
                    {
                        <div class="timeline-item">
                            <div class="timeline-marker bg-primary"></div>
                            <div class="timeline-content">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">Đặt lịch hoàn thành</h6>
                                        <small class="text-muted">@Model.Booking.CompletedAt.Value.ToString("dd/MM/yyyy HH:mm")</small>
                                    </div>
                                    <span class="badge bg-primary">Hoàn thành</span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Notes & Attachments -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-file-text me-2"></i>Ghi chú và đính kèm
                </h6>
                <button class="btn btn-sm btn-primary">
                    <i class="bi bi-plus-lg me-1"></i>Thêm ghi chú
                </button>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Ghi chú chi tiết</label>
                    <div class="p-3 bg-light rounded">
                        @if (!string.IsNullOrEmpty(Model.Booking.Notes))
                        {
                            <p class="mb-0">@Model.Booking.Notes</p>
                        }
                        else
                        {
                            <p class="mb-0 text-muted">Không có ghi chú</p>
                        }
                    </div>
                </div>
                @if (!string.IsNullOrEmpty(Model.Booking.PickupLocation) || !string.IsNullOrEmpty(Model.Booking.ReturnLocation))
                {
                    <div class="mb-3">
                        <label class="form-label">Địa điểm</label>
                        <div class="row g-2">
                            @if (!string.IsNullOrEmpty(Model.Booking.PickupLocation))
                            {
                                <div class="col-12">
                                    <small class="text-muted d-block">Điểm đón:</small>
                                    <p class="mb-0">@Model.Booking.PickupLocation</p>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(Model.Booking.ReturnLocation))
                            {
                                <div class="col-12">
                                    <small class="text-muted d-block">Điểm trả:</small>
                                    <p class="mb-0">@Model.Booking.ReturnLocation</p>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Right Column -->
    <div class="col-lg-4">
        <!-- Quick Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-lightning me-2"></i>Thao tác nhanh
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-success">
                        <i class="bi bi-box-arrow-in-right me-2"></i>Check-in
                    </button>
                    <button class="btn btn-primary" disabled>
                        <i class="bi bi-box-arrow-left me-2"></i>Check-out
                    </button>
                    <button class="btn btn-outline-primary">
                        <i class="bi bi-pencil me-2"></i>Chỉnh sửa
                    </button>
                    <button class="btn btn-outline-danger">
                        <i class="bi bi-x-circle me-2"></i>Hủy đặt lịch
                    </button>
                    <button class="btn btn-outline-secondary">
                        <i class="bi bi-printer me-2"></i>In
                    </button>
                </div>
            </div>
        </div>

        <!-- Vehicle Info -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-car-front me-2"></i>Thông tin xe
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label small text-muted">Xe</label>
                    <p class="mb-0">@Model.Booking.Vehicle?.Brand @Model.Booking.Vehicle?.Model</p>
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted">Biển số</label>
                    <p class="mb-0">@Model.Booking.Vehicle?.LicensePlate</p>
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted">Số km hiện tại</label>
                    <p class="mb-0"><strong>@(Model.Booking.Vehicle?.CurrentMileage?.ToString("N0") ?? "N/A") km</strong></p>
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted">Trạng thái</label>
                    <p class="mb-0">
                        @{
                            var vehicleStatusClass = Model.Booking.Vehicle?.Status switch
                            {
                                VehicleStatus.Active => "success",
                                VehicleStatus.Maintenance => "warning",
                                VehicleStatus.Repair => "danger",
                                VehicleStatus.Inactive => "secondary",
                                _ => "secondary"
                            };
                            var vehicleStatusText = Model.Booking.Vehicle?.Status switch
                            {
                                VehicleStatus.Active => "Hoạt động",
                                VehicleStatus.Maintenance => "Bảo trì",
                                VehicleStatus.Repair => "Sửa chữa",
                                VehicleStatus.Inactive => "Ngừng hoạt động",
                                _ => "N/A"
                            };
                        }
                        <span class="badge bg-@vehicleStatusClass">@vehicleStatusText</span>
                    </p>
                </div>
                <a asp-page="/Vehicles/Details" asp-route-id="@Model.Booking.VehicleId" class="btn btn-sm btn-outline-primary w-100">
                    <i class="bi bi-eye me-1"></i>Xem chi tiết xe
                </a>
            </div>
        </div>
    </div>
</div>

<style>
    .timeline {
        position: relative;
        padding-left: 30px;
    }

    .timeline-item {
        position: relative;
        padding-bottom: 20px;
    }

    .timeline-marker {
        position: absolute;
        left: -37px;
        top: 0;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 2px solid #fff;
        box-shadow: 0 0 0 2px currentColor;
    }

    .timeline-item:not(:last-child)::before {
        content: '';
        position: absolute;
        left: -32px;
        top: 12px;
        width: 2px;
        height: calc(100% - 12px);
        background: #e9ecef;
    }

    .timeline-content {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
    }
</style>

@section Scripts {
    <script>
        // Auto calculate km when check-out
        document.querySelector('input[placeholder="15080"]').addEventListener('input', function() {
            const startKm = parseInt(document.querySelector('input[placeholder="15000"]').value) || 0;
            const endKm = parseInt(this.value) || 0;
            if (endKm >= startKm) {
                document.querySelector('input[placeholder="80"]').value = endKm - startKm;
            }
        });
    </script>
}
}

