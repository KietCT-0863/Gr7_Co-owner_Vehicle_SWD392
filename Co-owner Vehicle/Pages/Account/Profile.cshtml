@page
@model Co_owner_Vehicle.Pages.Account.ProfileModel
@{
    ViewData["Title"] = "Hồ sơ cá nhân";
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold mb-1">
            <i class="bi bi-person-circle text-primary me-2"></i>Hồ sơ cá nhân
        </h2>
        <p class="text-muted mb-0">Quản lý thông tin tài khoản của bạn</p>
    </div>
</div>

@if (Model.CurrentUser != null)
{
    <div class="row g-4">
        <!-- Left Column - Profile Info -->
        <div class="col-lg-4">
            <!-- Avatar Card -->
            <div class="card mb-4">
                <div class="card-body text-center">
                    @{
                        var userName = Model.CurrentUser.FullName;
                        var userInitials = string.Join("", userName.Split(' ').Select(n => n.Length > 0 ? n[0].ToString() : "").Take(2));
                    }
                    <img src="https://ui-avatars.com/api/?name=@userInitials&background=4F46E5&color=fff&size=150" 
                         class="rounded-circle mb-3" width="150" height="150">
                    <h4 class="fw-bold mb-1">@Model.CurrentUser.FullName</h4>
                    <p class="text-muted mb-3">@Model.CurrentUser.Email</p>
                    <div class="d-flex gap-2 justify-content-center mb-3">
                        @foreach (var role in Model.UserRoles)
                        {
                            <span class="badge bg-primary">@role</span>
                        }
                        @if (Model.CurrentUser.IsVerified)
                        {
                            <span class="badge bg-success">Đã xác thực</span>
                        }
                        else
                        {
                            <span class="badge bg-warning">Chờ xác thực</span>
                        }
                    </div>
                    <button class="btn btn-outline-primary btn-sm w-100" disabled>
                        <i class="bi bi-camera me-2"></i>Thay đổi ảnh đại diện
                    </button>
                </div>
            </div>

            <!-- Account Status -->
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-shield-check me-2"></i>Trạng thái tài khoản
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                        <span class="text-muted">Email</span>
                        <span class="badge bg-@(Model.CurrentUser.IsVerified ? "success" : "warning")">
                            <i class="bi bi-@(Model.CurrentUser.IsVerified ? "check" : "clock")-circle me-1"></i>
                            @(Model.CurrentUser.IsVerified ? "Đã xác thực" : "Chờ xác thực")
                        </span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                        <span class="text-muted">Tài khoản</span>
                        <span class="badge bg-@(Model.CurrentUser.IsActive ? "success" : "danger")">
                            <i class="bi bi-@(Model.CurrentUser.IsActive ? "check" : "x")-circle me-1"></i>
                            @(Model.CurrentUser.IsActive ? "Hoạt động" : "Vô hiệu hóa")
                        </span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                        <span class="text-muted">Ngày đăng ký</span>
                        <span class="fw-semibold">@Model.CurrentUser.CreatedAt.ToString("dd/MM/yyyy")</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">Đã xác thực CCCD</span>
                        <span class="badge bg-@(!string.IsNullOrEmpty(Model.CurrentUser.CitizenId) ? "success" : "secondary")">
                            <i class="bi bi-@(!string.IsNullOrEmpty(Model.CurrentUser.CitizenId) ? "check" : "x")-circle me-1"></i>
                            @(!string.IsNullOrEmpty(Model.CurrentUser.CitizenId) ? "Có" : "Chưa có")
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Edit Forms -->
        <div class="col-lg-8">
            <!-- Personal Information -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-person me-2"></i>Thông tin cá nhân</span>
                    <button class="btn btn-sm btn-primary" id="editPersonalBtn">
                        <i class="bi bi-pencil me-1"></i>Chỉnh sửa
                    </button>
                </div>
                <div class="card-body">
                    <form method="post" asp-page-handler="EditPersonalInfo">
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Họ</label>
                                <input asp-for="EditPersonalInfo.FirstName" class="form-control" disabled>
                                <span asp-validation-for="EditPersonalInfo.FirstName" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Tên</label>
                                <input asp-for="EditPersonalInfo.LastName" class="form-control" disabled>
                                <span asp-validation-for="EditPersonalInfo.LastName" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" value="@Model.CurrentUser.Email" disabled>
                                <small class="text-muted">Email không thể thay đổi</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Số điện thoại</label>
                                <input asp-for="EditPersonalInfo.PhoneNumber" class="form-control" disabled>
                                <span asp-validation-for="EditPersonalInfo.PhoneNumber" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Ngày sinh</label>
                                <input asp-for="EditPersonalInfo.DateOfBirth" type="date" class="form-control" disabled>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Số CCCD/CMND</label>
                                <input asp-for="EditPersonalInfo.CitizenId" class="form-control" disabled>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Giấy phép lái xe</label>
                                <input asp-for="EditPersonalInfo.DriverLicenseNumber" class="form-control" disabled>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Ngày đăng ký</label>
                                <input type="text" class="form-control" value="@Model.CurrentUser.CreatedAt.ToString("dd/MM/yyyy")" disabled>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Địa chỉ</label>
                                <textarea asp-for="EditPersonalInfo.Address" class="form-control" rows="2" disabled></textarea>
                            </div>
                        </div>
                        <div class="mt-3 d-none" id="personalActions">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="bi bi-check-lg me-1"></i>Lưu thay đổi
                            </button>
                            <button type="button" class="btn btn-secondary" id="cancelPersonalBtn">Hủy</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Change Password -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-key me-2"></i>Đổi mật khẩu
                </div>
                <div class="card-body">
                    <form method="post" asp-page-handler="ChangePassword">
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Mật khẩu hiện tại</label>
                                <input asp-for="ChangePassword.CurrentPassword" class="form-control" placeholder="Nhập mật khẩu hiện tại">
                                <span asp-validation-for="ChangePassword.CurrentPassword" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Mật khẩu mới</label>
                                <input asp-for="ChangePassword.NewPassword" class="form-control" placeholder="Nhập mật khẩu mới">
                                <span asp-validation-for="ChangePassword.NewPassword" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Xác nhận mật khẩu mới</label>
                                <input asp-for="ChangePassword.ConfirmPassword" class="form-control" placeholder="Nhập lại mật khẩu mới">
                                <span asp-validation-for="ChangePassword.ConfirmPassword" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-shield-lock me-2"></i>Đổi mật khẩu
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Activity Stats -->
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-graph-up me-2"></i>Thống kê hoạt động
                </div>
                <div class="card-body">
                    <div class="row g-3 text-center">
                        <div class="col-md-3">
                            <div class="p-3 bg-light rounded">
                                <h3 class="fw-bold text-primary mb-1">@Model.Stats.TotalVehicles</h3>
                                <small class="text-muted">Xe đang sở hữu</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 bg-light rounded">
                                <h3 class="fw-bold text-success mb-1">@Model.Stats.TotalBookings</h3>
                                <small class="text-muted">Lượt đặt lịch</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 bg-light rounded">
                                <h3 class="fw-bold text-warning mb-1">@($"{Model.Stats.TotalExpenses:N0}")</h3>
                                <small class="text-muted">Tổng chi phí (VNĐ)</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 bg-light rounded">
                                <h3 class="fw-bold text-danger mb-1">@($"{Model.Stats.UsagePercentage:N0}")%</h3>
                                <small class="text-muted">Tỷ lệ sử dụng</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="alert alert-warning">
        Không tìm thấy thông tin người dùng.
    </div>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Enable edit mode
        document.getElementById('editPersonalBtn')?.addEventListener('click', function() {
            const form = this.closest('.card').querySelector('form');
            const inputs = form.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                // Enable all inputs except email and date fields that are not editable
                if (input.type === 'email' || (input.type === 'text' && input.value.match(/\d{2}\/\d{2}\/\d{4}/))) {
                    return; // Skip email and date text fields
                }
                input.disabled = false;
            });
            document.getElementById('personalActions')?.classList.remove('d-none');
            this.classList.add('d-none');
        });
        
        // Cancel edit
        document.getElementById('cancelPersonalBtn')?.addEventListener('click', function() {
            const form = this.closest('form');
            const inputs = form.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                if (input.type === 'email' || (input.type === 'text' && input.value.match(/\d{2}\/\d{2}\/\d{4}/))) {
                    return; // Skip email and date text fields
                }
                input.disabled = true;
            });
            document.getElementById('personalActions')?.classList.add('d-none');
            document.getElementById('editPersonalBtn')?.classList.remove('d-none');
            // Reload page to reset form values
            location.reload();
        });
    </script>
}

