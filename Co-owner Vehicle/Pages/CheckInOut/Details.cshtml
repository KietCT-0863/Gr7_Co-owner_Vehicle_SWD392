@page
@model Co_owner_Vehicle.Pages.CheckInOut.DetailsModel
@{
    ViewData["Title"] = "Chi tiết Check-in/Check-out";
}

<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-2">
                <li class="breadcrumb-item"><a asp-page="/CheckInOut/Index">Check-in/Check-out</a></li>
                <li class="breadcrumb-item active">Chi tiết</li>
            </ol>
        </nav>
        <h2 class="fw-bold mb-1">
            <i class="bi bi-box-arrow-in-right text-primary me-2"></i>Chi tiết Check-in/Check-out
        </h2>
        <p class="text-muted mb-0">Thông tin chi tiết quá trình nhận/trả xe</p>
    </div>
</div>

<div class="row g-4">
    <!-- Left Column -->
    <div class="col-lg-8">
        <!-- Check-in Details -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0">
                    <i class="bi bi-box-arrow-in-right me-2"></i>Check-in
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label small text-muted">Thời gian</label>
                        <p class="fw-bold mb-0">29/10/2024 08:00</p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small text-muted">Thành viên</label>
                        <div class="d-flex align-items-center">
                            <div class="avatar-xs bg-primary text-white me-2">NV</div>
                            <span>Nguyễn Văn A</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small text-muted">Xe</label>
                        <p class="mb-0">Tesla Model 3 - 30A-12345</p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small text-muted">Số km</label>
                        <p class="fw-bold mb-0">15,000 km</p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small text-muted">Trạng thái xe</label>
                        <p class="mb-0"><span class="badge bg-success">Tốt</span></p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small text-muted">Vị trí</label>
                        <p class="mb-0">Bãi đỗ xe số 1</p>
                    </div>
                    <div class="col-12">
                        <label class="form-label small text-muted">Ghi chú</label>
                        <p class="mb-0">Nhận xe đi công tác tại TP.HCM</p>
                    </div>
                    <div class="col-12">
                        <label class="form-label small text-muted">Hình ảnh</label>
                        <div class="d-flex gap-2">
                            <img src="https://via.placeholder.com/200x150" class="img-thumbnail" style="width: 150px;">
                            <img src="https://via.placeholder.com/200x150" class="img-thumbnail" style="width: 150px;">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Check-out Details -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">
                    <i class="bi bi-box-arrow-left me-2"></i>Check-out
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label small text-muted">Thời gian</label>
                        <p class="fw-bold mb-0">29/10/2024 12:00</p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small text-muted">Thành viên</label>
                        <div class="d-flex align-items-center">
                            <div class="avatar-xs bg-primary text-white me-2">NV</div>
                            <span>Nguyễn Văn A</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small text-muted">Xe</label>
                        <p class="mb-0">Tesla Model 3 - 30A-12345</p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small text-muted">Số km</label>
                        <p class="fw-bold mb-0">15,080 km</p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small text-muted">Tổng số km đã đi</label>
                        <p class="fw-bold text-success mb-0">80 km</p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small text-muted">Trạng thái xe</label>
                        <p class="mb-0"><span class="badge bg-success">Tốt</span></p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small text-muted">Vị trí</label>
                        <p class="mb-0">Bãi đỗ xe số 1</p>
                    </div>
                    <div class="col-12">
                        <label class="form-label small text-muted">Ghi chú</label>
                        <p class="mb-0">Trả xe sau công tác, xe trong tình trạng tốt</p>
                    </div>
                    <div class="col-12">
                        <label class="form-label small text-muted">Hình ảnh</label>
                        <div class="d-flex gap-2">
                            <img src="https://via.placeholder.com/200x150" class="img-thumbnail" style="width: 150px;">
                            <img src="https://via.placeholder.com/200x150" class="img-thumbnail" style="width: 150px;">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Usage Summary -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-speedometer2 me-2"></i>Tóm tắt sử dụng
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="text-center p-3 bg-light rounded">
                            <h6 class="text-muted mb-2">Thời gian sử dụng</h6>
                            <h4 class="fw-bold mb-0">4 giờ</h4>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3 bg-light rounded">
                            <h6 class="text-muted mb-2">Tổng số km</h6>
                            <h4 class="fw-bold mb-0">80 km</h4>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3 bg-light rounded">
                            <h6 class="text-muted mb-2">Mức độ sử dụng</h6>
                            <h4 class="fw-bold mb-0">Bình thường</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column -->
    <div class="col-lg-4">
        <!-- QR Code -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-qr-code me-2"></i>QR Code
                </h6>
            </div>
            <div class="card-body text-center">
                <div class="bg-light p-4 rounded mb-3">
                    <div class="bg-white p-3 d-inline-block rounded" id="qrcode">
                        <div style="width: 200px; height: 200px; background: #000; display: flex; align-items: center; justify-content: center;">
                            <i class="bi bi-qr-code fs-1 text-white"></i>
                        </div>
                    </div>
                </div>
                <p class="text-muted small mb-0">Quét QR code để check-in/check-out nhanh</p>
                <button class="btn btn-primary mt-3" onclick="generateQRCode(@Model.Record?.VehicleId)">
                    <i class="bi bi-arrow-clockwise me-2"></i>Tạo QR Code
                </button>
                <button class="btn btn-outline-primary mt-3" onclick="downloadQRCode()" style="display: none;" id="downloadBtn">
                    <i class="bi bi-download me-2"></i>Tải QR Code
                </button>
                <div id="qrDataDisplay" class="mt-3" style="display: none;">
                    <label class="form-label small">QR Code Data:</label>
                    <textarea class="form-control form-control-sm" id="qrDataText" readonly rows="2"></textarea>
                    <button class="btn btn-sm btn-outline-secondary mt-2" onclick="copyQRData()">
                        <i class="bi bi-clipboard me-1"></i>Copy
                    </button>
                </div>
            </div>
        </div>

        <!-- Related Booking -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-calendar-check me-2"></i>Đặt lịch liên quan
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <strong>Đặt lịch số #123</strong>
                </div>
                <div class="small text-muted mb-2">
                    29/10/2024 08:00 - 12:00
                </div>
                <div class="mb-2">
                    <span class="badge bg-success">Đã xác nhận</span>
                </div>
                <a href="#" class="btn btn-sm btn-outline-primary w-100">
                    <i class="bi bi-eye me-1"></i>Xem chi tiết
                </a>
            </div>
        </div>

        <!-- Actions -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-lightning me-2"></i>Thao tác
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary">
                        <i class="bi bi-pencil me-2"></i>Chỉnh sửa
                    </button>
                    <button class="btn btn-outline-danger">
                        <i class="bi bi-trash me-2"></i>Xóa
                    </button>
                    <button class="btn btn-outline-secondary">
                        <i class="bi bi-printer me-2"></i>In
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script>
        let qrCode = null;

        async function generateQRCode(vehicleId) {
            if (!vehicleId) {
                alert('Không tìm thấy thông tin vehicle');
                return;
            }

            try {
                const response = await fetch(`/api/qrcode/generate/${vehicleId}`);
                const data = await response.json();

                if (response.ok) {
                    // Clear previous QR code
                    document.getElementById('qrcode').innerHTML = '';

                    // Generate new QR code
                    qrCode = new QRCode(document.getElementById('qrcode'), {
                        text: data.qrData,
                        width: 200,
                        height: 200,
                        colorDark: '#000000',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.H
                    });

                    // Show QR data and download button
                    document.getElementById('qrDataDisplay').style.display = 'block';
                    document.getElementById('qrDataText').value = data.qrData;
                    document.getElementById('downloadBtn').style.display = 'inline-block';
                } else {
                    alert(data.message || 'Không thể tạo QR code');
                }
            } catch (error) {
                alert('Lỗi kết nối: ' + error.message);
            }
        }

        function downloadQRCode() {
            if (qrCode) {
                // Get the QR code canvas
                const canvas = document.querySelector('#qrcode canvas');
                if (canvas) {
                    const url = canvas.toDataURL('image/png');
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'qrcode.png';
                    a.click();
                }
            }
        }

        function copyQRData() {
            const qrDataText = document.getElementById('qrDataText');
            qrDataText.select();
            document.execCommand('copy');
            alert('Đã copy QR code data vào clipboard!');
        }
    </script>
}
